<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.134.3"><meta name=description content><meta name=author content="voankhangpt@gmail.com"><link rel=icon href=../../images/favicon.png type=image/png><title>Blog 2 :: Internship Report</title>
<link href=../../css/nucleus.css?1765364014 rel=stylesheet><link href=../../css/fontawesome-all.min.css?1765364014 rel=stylesheet><link href=../../css/hybrid.css?1765364014 rel=stylesheet><link href=../../css/featherlight.min.css?1765364014 rel=stylesheet><link href=../../css/perfect-scrollbar.min.css?1765364014 rel=stylesheet><link href=../../css/auto-complete.css?1765364014 rel=stylesheet><link href=../../css/atom-one-dark-reasonable.css?1765364014 rel=stylesheet><link href=../../css/theme.css?1765364014 rel=stylesheet><link href=../../css/hugo-theme.css?1765364014 rel=stylesheet><link href=../../css/theme-workshop.css?1765364014 rel=stylesheet><script src=../../js/jquery-3.3.1.min.js?1765364014></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=../../3-blogstranslated/3.2-blog2/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=../../><svg id="Layer_1" data-name="Layer 1" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff}.cls-2{fill:#f90;fill-rule:evenodd}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09 10.85a4.7 4.7.0 00.19 1.48 7.73 7.73.0 00.54 1.19.77.77.0 01.12.38.64.64.0 01-.32.49l-1 .7a.83.83.0 01-.44.15.69.69.0 01-.49-.23 3.8 3.8.0 01-.6-.77q-.25-.42-.51-1a6.14 6.14.0 01-4.89 2.3 4.54 4.54.0 01-3.32-1.19 4.27 4.27.0 01-1.22-3.2 4.28 4.28.0 011.46-3.4A6.06 6.06.0 017.69 6.46a12.47 12.47.0 011.76.13q.92.13 1.91.36V5.73a3.65 3.65.0 00-.79-2.66A3.81 3.81.0 007.86 2.3a7.71 7.71.0 00-1.79.22 12.78 12.78.0 00-1.79.57 4.55 4.55.0 01-.58.22h-.26q-.35.0-.35-.52V2a1.09 1.09.0 01.12-.58 1.2 1.2.0 01.47-.35A10.88 10.88.0 015.77.32 10.19 10.19.0 018.36.0a6 6 0 014.35 1.35 5.49 5.49.0 011.38 4.09zM7.34 13.38a5.36 5.36.0 001.72-.31A3.63 3.63.0 0010.63 12 2.62 2.62.0 0011.19 11a5.63 5.63.0 00.16-1.44v-.7a14.35 14.35.0 00-1.53-.28 12.37 12.37.0 00-1.56-.1 3.84 3.84.0 00-2.47.67A2.34 2.34.0 005 11a2.35 2.35.0 00.61 1.76A2.4 2.4.0 007.34 13.38zm13.35 1.8a1 1 0 01-.64-.16 1.3 1.3.0 01-.35-.65L15.81 1.51a3 3 0 01-.15-.67.36.36.0 01.41-.41H17.7a1 1 0 01.65.16 1.4 1.4.0 01.33.65l2.79 11 2.59-11A1.17 1.17.0 0124.39.6a1.1 1.1.0 01.67-.16H26.4a1.1 1.1.0 01.67.16 1.17 1.17.0 01.32.65L30 12.39 32.88 1.25A1.39 1.39.0 0133.22.6a1 1 0 01.65-.16h1.54a.36.36.0 01.41.41 1.36 1.36.0 010 .26 3.64 3.64.0 01-.12.41l-4 12.86a1.3 1.3.0 01-.35.65 1 1 0 01-.64.16H29.25a1 1 0 01-.67-.17 1.26 1.26.0 01-.32-.67L25.67 3.64l-2.56 10.7a1.26 1.26.0 01-.32.67 1 1 0 01-.67.17zm21.36.44a11.28 11.28.0 01-2.56-.29 7.44 7.44.0 01-1.92-.67 1 1 0 01-.61-.93v-.84q0-.52.38-.52a.9.9.0 01.31.06l.42.17a8.77 8.77.0 001.83.58 9.78 9.78.0 002 .2 4.48 4.48.0 002.43-.55 1.76 1.76.0 00.86-1.57 1.61 1.61.0 00-.45-1.16A4.29 4.29.0 0043 9.22l-2.41-.76A5.15 5.15.0 0138 6.78a3.94 3.94.0 01-.83-2.41 3.7 3.7.0 01.45-1.85 4.47 4.47.0 011.19-1.37 5.27 5.27.0 011.7-.86A7.4 7.4.0 0142.6.0a8.87 8.87.0 011.12.07q.57.07 1.08.19t.95.26a4.27 4.27.0 01.7.29 1.59 1.59.0 01.49.41.94.94.0 01.15.55v.79q0 .52-.38.52a1.76 1.76.0 01-.64-.2 7.74 7.74.0 00-3.2-.64 4.37 4.37.0 00-2.21.47 1.6 1.6.0 00-.79 1.48 1.58 1.58.0 00.49 1.18 4.94 4.94.0 001.83.92L44.55 7a5.08 5.08.0 012.57 1.6A3.76 3.76.0 0147.9 11a4.21 4.21.0 01-.44 1.93 4.4 4.4.0 01-1.21 1.47 5.43 5.43.0 01-1.85.93A8.25 8.25.0 0142.05 15.62z"/><path class="cls-2" d="M45.19 23.81C39.72 27.85 31.78 30 25 30A36.64 36.64.0 01.22 20.57c-.51-.46-.06-1.09.56-.74A49.78 49.78.0 0025.53 26.4 49.23 49.23.0 0044.4 22.53C45.32 22.14 46.1 23.14 45.19 23.81z"/><path class="cls-2" d="M47.47 21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74 3.13-2.2 8.27-1.57 8.86-.83s-.16 5.89-3.09 8.35c-.45.38-.88.18-.68-.32C46.69 25.8 48.17 22.11 47.47 21.21z"/></svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=../../js/lunr.min.js?1765364014></script><script type=text/javascript src=../../js/auto-complete.js?1765364014></script><script type=text/javascript>var baseurl="https://khangvo05.github.io/vo-an-khang-fptse190618-internship-report/"</script><script type=text/javascript src=../../js/search.js?1765364014></script></div><div class=highlightable><ul class=topics><li data-nav-id=/1-worklog/ title=Worklog class=dd-item><a href=../../1-worklog/><b>1. </b>Worklog
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/1-worklog/1.1-week1/ title="Week 1 Worklog" class=dd-item><a href=../../1-worklog/1.1-week1/><b>1.1. </b>Week 1 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.2-week2/ title="Week 2 Worklog" class=dd-item><a href=../../1-worklog/1.2-week2/><b>1.2. </b>Week 2 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.3-week3/ title="Week 3 Worklog" class=dd-item><a href=../../1-worklog/1.3-week3/><b>1.3. </b>Week 3 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.4-week4/ title="Week 4 Worklog" class=dd-item><a href=../../1-worklog/1.4-week4/><b>1.4. </b>Week 4 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.5-week5/ title="Week 5 Worklog" class=dd-item><a href=../../1-worklog/1.5-week5/><b>1.5. </b>Week 5 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.6-week6/ title="Week 6 Worklog" class=dd-item><a href=../../1-worklog/1.6-week6/><b>1.6. </b>Week 6 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.7-week7/ title="Week 7 Worklog" class=dd-item><a href=../../1-worklog/1.7-week7/><b>1.7. </b>Week 7 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.8-week8/ title="Week 8 Worklog" class=dd-item><a href=../../1-worklog/1.8-week8/><b>1.8. </b>Week 8 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.9-week9/ title="Week 9 Worklog" class=dd-item><a href=../../1-worklog/1.9-week9/><b>1.7. </b>Week 9 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.10-week10/ title="Week 10 Worklog" class=dd-item><a href=../../1-worklog/1.10-week10/><b>1.8. </b>Week 10 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.11-week11/ title="Week 11 Worklog" class=dd-item><a href=../../1-worklog/1.11-week11/><b>1.11. </b>Week 11 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.12-week12/ title="Week 12 Worklog" class=dd-item><a href=../../1-worklog/1.12-week12/><b>1.12. </b>Week 12 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.13-week13/ title="Week 13 Worklog" class=dd-item><a href=../../1-worklog/1.13-week13/><b>1.13. </b>Week 13 Worklog
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/2-proposal/ title=Proposal class=dd-item><a href=../../2-proposal/><b>2. </b>Proposal
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/3-blogstranslated/ title="Translated Blogs" class="dd-item
parent"><a href=../../3-blogstranslated/><b>3. </b>Translated Blogs
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/3-blogstranslated/3.1-blog1/ title="Blog 1" class=dd-item><a href=../../3-blogstranslated/3.1-blog1/><b>3.1. </b>Blog 1
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/3-blogstranslated/3.2-blog2/ title="Blog 2" class="dd-item
active"><a href=../../3-blogstranslated/3.2-blog2/><b>3.2. </b>Blog 2
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/3-blogstranslated/3.3-blog3/ title="Blog 3" class=dd-item><a href=../../3-blogstranslated/3.3-blog3/><b>3.3. </b>Blog 3
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/4-eventparticipated/ title="Events Participated" class=dd-item><a href=../../4-eventparticipated/><b>4. </b>Events Participated
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/4-eventparticipated/4.1-event1/ title="Event 1" class=dd-item><a href=../../4-eventparticipated/4.1-event1/><b>4.1. </b>Event 1
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4-eventparticipated/4.2-event2/ title="Event 2" class=dd-item><a href=../../4-eventparticipated/4.2-event2/><b>4.2. </b>Event 2
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4-eventparticipated/4.3-event3/ title="Event 3" class=dd-item><a href=../../4-eventparticipated/4.3-event3/><b>4.3. </b>Event 3
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/5-workshop/ title=Workshop class=dd-item><a href=../../5-workshop/><b>5. </b>Workshop
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/5-workshop/5.1-workshop-overview/ title=Introduction class=dd-item><a href=../../5-workshop/5.1-workshop-overview/><b>5.1. </b>Introduction
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/5.2-prerequiste/ title=Prerequiste class=dd-item><a href=../../5-workshop/5.2-prerequiste/><b>5.2. </b>Prerequiste
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/5.3-run-cloudformation-stack/ title="Set up cloudformation" class=dd-item><a href=../../5-workshop/5.3-run-cloudformation-stack/><b>5.3. </b>Set up cloudformation
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/5.4-set-up-website/ title="Set up website" class=dd-item><a href=../../5-workshop/5.4-set-up-website/><b>5.4. </b>Set up website
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/5.5-event-bridge/ title="EventBridge and Lambda Setup" class=dd-item><a href=../../5-workshop/5.5-event-bridge/><b>5.5. </b>EventBridge and Lambda Setup
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/5.6-sns/ title="SNS Setup" class=dd-item><a href=../../5-workshop/5.6-sns/><b>5.6. </b>SNS Setup
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/5.7-test-website-iot-connection/ title="Test website and IoT connection" class=dd-item><a href=../../5-workshop/5.7-test-website-iot-connection/><b>5.7. </b>Test website and IoT connection
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/6-self-evaluation/ title=Self-Assessment class=dd-item><a href=../../6-self-evaluation/><b>6. </b>Self-Assessment
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/7-feedback/ title="Sharing and Feedback" class=dd-item><a href=../../7-feedback/><b>7. </b>Sharing and Feedback
<i class="fas fa-check read-icon"></i></a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://www.facebook.com/groups/awsstudygroupfcj/><i class='fab fa-facebook'></i> AWS Study Group</a></li></ul></section><section id=prefooter><hr><ul><li><a class=padding><i class="fas fa-language fa-fw"></i><div class=select-style><select id=select-language onchange="location=this.value"><option id=en value=https://khangvo05.github.io/vo-an-khang-fptse190618-internship-report/3-blogstranslated/3.2-blog2/ selected>English</option><option id=vi value=https://khangvo05.github.io/vo-an-khang-fptse190618-internship-report/vi/3-blogstranslated/3.2-blog2/>Tiếng Việt</option></select><svg id="Capa_1" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><polygon points="0,63.75 127.5,191.25 255,63.75"/></g></g></svg></div></a></li><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></section><section id=footer><left><b>Workshop</b><br><img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title=Migrate alt="web counter" border=0></a><br><b><a href=https://cloudjourney.awsstudygroup.com/>Cloud Journey</a></b><br><img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" alt="web counter" border=0>
</left><left><br><br><b>Last Updated</b><br><i><span id=lastUpdated style=color:orange></span>
</i><script>const today=new Date,formattedDate=today.toLocaleDateString("en-GB");document.getElementById("lastUpdated").textContent=formattedDate</script></left><left><br><br><b>Team</b><br><i><a href=https://www.facebook.com/groups/660548818043427 style=color:orange>First Cloud Journey</a><br></i></left><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=../../>Internship Report</a> > <a href=../../3-blogstranslated/>Translated Blogs</a> > Blog 2</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#background-how-snapstart-works>Background: How SnapStart works</a></li><li><a href=#priming-explained>Priming explained</a><ul><li><a href=#example-priming-implementation-using-crac-runtime-hooks-before-taking-a-lambda-snapshot>Example priming Implementation using CRaC runtime hooks before taking a Lambda snapshot</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Blog 2</h1><h1 id=optimizing-cold-start-performance-of-aws-lambda-using-advanced-priming-strategies-with-snapstart>Optimizing cold start performance of AWS Lambda using advanced priming strategies with SnapStart</h1><p>by Shan Kandaswamy and Gustavo Martim | on 29 APR 2025 | in <a href=https://aws.amazon.com/blogs/compute/category/learning-levels/advanced-300/>Advanced (300)</a>, <a href=https://aws.amazon.com/blogs/compute/category/compute/aws-lambda/>AWS Lambda</a>, <a href=https://aws.amazon.com/blogs/compute/category/post-types/best-practices/>Best Practices</a>, <a href=https://aws.amazon.com/blogs/compute/category/serverless/>Serverless</a>, <a href=https://aws.amazon.com/blogs/compute/category/post-types/technical-how-to/>Technical How-to</a> | <a href=https://aws.amazon.com/blogs/compute/optimizing-cold-start-performance-of-aws-lambda-using-advanced-priming-strategies-with-snapstart/>Permalink</a> | Share</p><p>Introduced at re:Invent 2022, <a href=https://docs.aws.amazon.com/lambda/latest/dg/snapstart.html>SnapStart</a> is a performance optimization that makes it easier to build highly responsive and scalable applications using <a href=https://aws.amazon.com/lambda/>AWS Lambda</a>. The largest contributor to startup latency (often referred to as cold-start time) is the time spent initializing a function. This includes loading the function&rsquo;s code and initializing dependencies. For latency-sensitive workloads such as APIs and real-time data processing applications, high startup latency can result in a suboptimal end user experience. Lambda SnapStart can reduce startup duration from several seconds to as low as sub-second, with minimal or no code changes. This post discusses &lsquo;Priming&rsquo;, a technique to further optimize startup times for AWS Lambda functions built using Java and Spring Boot.</p><p>Spring Boot applications typically experience high cold start latency during JVM and framework initialization, where significant time is spent loading classes and performing Just-In-Time (JIT) compilation of Java bytecode. This blog post uses a Spring Boot application as an example that retrieves 10 records from a &lsquo;UnicornEmployee&rsquo; table in an <a href=https://aws.amazon.com/rds/>Amazon RDS</a> for PostgreSQL database, where each employee record includes employee name, location, and hire date.</p><p>The sample application uses <a href=https://aws.amazon.com/api-gateway/>Amazon API Gateway</a> which triggers an AWS Lambda function that connects to the database through RDS Proxy to return the employee data. While this sample application uses dummy employee data for demonstration, the patterns and optimization techniques discussed in this post are applicable to real-world scenarios with similar data access patterns. Sample code for this implementation can be found in our GitHub repository at <a href=https://github.com/aws-samples/lambda-priming-crac-java-cdk>lambda-priming-crac-java-cdk</a>.</p><h2 id=background-how-snapstart-works>Background: How SnapStart works</h2><p>The post assumes familiarity with SnapStart and provides a short background. For additional details, refer to the <a href=https://docs.aws.amazon.com/lambda/latest/dg/snapstart.html>SnapStart documentation</a>.</p><p>To quickly recap, the <a href=https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtime-environment.html>INIT</a> phase for a Lambda function involves downloading the function&rsquo;s code, starting the runtime and any external dependencies, and running the function&rsquo;s initialization code. For functions that don&rsquo;t use SnapStart, this phase occurs each time your application scales up to create a new execution environment. When SnapStart is activated, the INIT phase happens when you publish a function version.</p><p>The following image shows a comparison of a Lambda request lifecycle with and without SnapStart.</p><p><img alt="Lambda Request Lifecycle Comparison" src=../../images/blog-2/ComputeBlog-2165img1.png></p><p><em>Figure 1 – comparison of a Lambda request lifecycle with and without SnapStart</em></p><p>At the end of the INIT phase, Lambda executes your before-checkpoint <a href=https://docs.aws.amazon.com/lambda/latest/dg/snapstart-runtime-hooks.html>runtime hooks</a>. Lambda then snapshots the memory and disk state of the initialized execution environment, persists the encrypted snapshot, and caches it for low-latency access. When the function is subsequently invoked, new execution environments are resumed from the cached snapshot (during the <a href=https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtime-environment.html#runtimes-lifecycle-restore>RESTORE</a> phase), speeding up function startup.</p><p><img alt="Execution Environments Resume from Snapshot" src=../../images/blog-2/ComputeBlog-2165img2.png></p><p><em>Figure 2 – new execution environments are resumed from the cached snapshot</em></p><p>You can validate this speedup by comparing the RESTORE duration with the INIT duration recorded before SnapStart in your Lambda function&rsquo;s <a href=https://aws.amazon.com/cloudwatch/>Amazon CloudWatch</a> Logs. As demonstrated in the following table, enabling SnapStart reduces the startup latency of our sample Spring Boot application by 4.3x from 6.1s to 1.4s. The 6.1s cold start latency for <code>ON_DEMAND</code> is primarily due to the combination of (1) initializing the JVM and Spring Boot framework, (2) JIT compilation of lazy loaded application code during initial invocation and (3) the time needed to establish a database connection with RDS through <a href=https://aws.amazon.com/rds/proxy/>Amazon RDS Proxy</a>. By enabling SnapStart, Lambda initializes the JVM and Spring Boot prior to the function invocation – resulting in the significantly reduced latency of 1.4s.</p><table><thead><tr><th style=text-align:left>Method</th><th style=text-align:left>Cold Start Invocations</th><th style=text-align:left>p50</th><th style=text-align:left>P90</th><th style=text-align:left>P99</th><th style=text-align:left>p99.9</th></tr></thead><tbody><tr><td style=text-align:left>PrimingLogGroup-1_ON_DEMAND</td><td style=text-align:left>128</td><td style=text-align:left>5047.94 ms</td><td style=text-align:left>5386.78 ms</td><td style=text-align:left>6158.80 ms</td><td style=text-align:left>6195.84 ms</td></tr><tr><td style=text-align:left>PrimingLogGroup-2_SnapStart_NO_PRIMING</td><td style=text-align:left>111</td><td style=text-align:left>1177.87 ms</td><td style=text-align:left>1288.73 ms</td><td style=text-align:left>1419.94 ms</td><td style=text-align:left>1425.63 ms</td></tr></tbody></table><p>You can reduce cold starts even further for your latency-sensitive Spring Boot applications by using priming techniques on Lambda functions. Let&rsquo;s explore how to implement priming techniques.</p><h2 id=priming-explained>Priming explained</h2><p>Priming is the process of preloading dependencies and initializing resources during the INIT phase, rather than during the INVOKE phase to further optimize startup performance with SnapStart. This is required because Java frameworks that use dependency injection load classes into memory when these classes are explicitly invoked, which typically happens during Lambda&rsquo;s INVOKE phase. You can proactively load classes using <a href=https://docs.aws.amazon.com/lambda/latest/dg/snapstart-runtime-hooks-java.html>Java runtime hooks</a>, that are part of the open source <a href=https://openjdk.org/projects/crac/>CRaC </a>(Coordinated Restore at Checkpoint) project. This post demonstrates how to use this hook, called <code>beforeCheckpoint()</code>, to prime SnapStart-enabled Java functions, in two ways:</p><ol><li><p><strong>Invoke Priming</strong>: This approach involves directly invoking application endpoints or methods in your pre-snapshotting hook so that they are JIT compiled during the INIT phase and included in the snapshot. This can include operations such as invoking API Gateway endpoints or fetching data from an S3 bucket or RDS database to proactively execute the code paths, ensuring that the underlying classes are included in the snapshot.</p></li><li><p><strong>Class Priming</strong>: This approach involves proactive initialization of classes during the INIT phase, ensuring that they are included in the function&rsquo;s snapshot without risking unwanted changes to application state or data. This can be achieved by leveraging Java&rsquo;s <code>forName()</code> method, which loads, links, and initializes the specified class. Initialization refers to the JVM process of loading the class definition into memory, verifying the bytecode, preparing static fields with default values, and executing static initializers. This is different from instantiation, which creates objects of the class using constructors. To generate a list of the classes required for pre-loading, you can use the following VM option, writing the list to a file called classes-loaded.txt: <code>-Xlog:class+load=info:classes-loaded.txt</code></p></li></ol><p>While invoke priming can offer better performance, it requires additional effort to ensure that the actions performed are idempotent and do not have unintended side effects, for instance processing financial transactions in a banking application. For this reason, invoke priming should only be used when code executed during priming is either idempotent or does not modify state. For scenarios where this is not possible, class priming provides a safer alternative by only initializing classes without executing their methods. Note that this assumes your application does not execute state-modifying code during class initialization.</p><p>With this context, let&rsquo;s look at how to implement Invoke and Class priming for a Spring Boot sample application.</p><h3 id=example-priming-implementation-using-crac-runtime-hooks-before-taking-a-lambda-snapshot>Example priming Implementation using CRaC runtime hooks before taking a Lambda snapshot</h3><p>This post demonstrates both Invoke priming and Class priming using the sample Spring Boot application. The choice between the two approaches depends on the specific requirements and complexities of your application.</p><p><strong>Step 1: Set up your Spring Boot Application</strong> using the <code>aws-serverless-springboot3-archetype</code> as explained in our <a href=https://github.com/aws/serverless-java-container/wiki/Quick-start---Spring-Boot3>Quick Start Spring Boot3</a> guide, adding database connectivity code, or simply clone the sample project from <a href=https://github.com/aws-samples/lambda-priming-crac-java-cdk>GitHub repository</a>.</p><ol><li>Create a Spring Boot Application.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// src/main/java/software/amazon/awscdk/examples/unicorn/UnicornApplication.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> software.amazon.awscdk.examples.unicorn;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>…</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Import</span>({ UnicornConfig.<span style=color:#a6e22e>class</span> })
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnicornApplication</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger log <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(UnicornApplication.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String... arguments) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(UnicornApplication.<span style=color:#a6e22e>class</span>, arguments);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>Add all the necessary Maven dependencies for Spring Boot, AWS Lambda, and Database Connection in your <a href=https://github.com/aws-samples/lambda-priming-crac-java-cdk/blob/main/software/priming/pom.xml>pom.xml</a> file. The following, highlighted, dependency contains the classes required to use the CRaC runtime hooks.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>...
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;groupId&gt;</span>org.crac<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;artifactId&gt;</span>crac<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><ol start=3><li>Configure Database Connection – Set up the database connection details in application.properties.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>${SPRING_DATASOURCE_PASSWORD} </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.url</span><span style=color:#f92672>=</span><span style=color:#e6db74>${SPRING_DATASOURCE_URL} </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.username</span><span style=color:#f92672>=</span><span style=color:#e6db74>postgres </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.hikari.maximumPoolSize</span><span style=color:#f92672>=</span><span style=color:#e6db74>1 </span>
</span></span></code></pre></div><p><strong>Step 2: Implement Lambda Function Handler with CRaC runtime hooks and Invoke Priming Approach:</strong></p><p>Create Lambda Function Handler and integrate CRaC runtime hooks to execute <code>beforeCheckpoint()</code> and <code>afterRestore()</code> methods in your application for before taking and after restoring the snapshot.</p><ol><li>Implement the <code>RequestHandler&lt;UnicornRequest, UnicornResponse></code> interface in the Lambda function handler class.</li><li>Implement the CRaC resource interface with two methods: <code>beforeCheckpoint()</code> and <code>afterRestore()</code>, which defines actions performed before Lambda creates the snapshot and after the snapshot is restored.</li><li>Add invoke priming by creating a <code>UnicornRequest</code> object with a <code>GET</code> request to a specific endpoint (such as, <code>/unicorn</code>) and call the <code>handleRequest(unicornRequest, null)</code> method.</li></ol><p>This ensures that the code paths associated with the specified endpoint are JIT compiled and optimized for faster execution during the first invocation after the snapshot is restored.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>main<span style=color:#f92672>/</span>java<span style=color:#f92672>/</span>software<span style=color:#f92672>/</span>amazon<span style=color:#f92672>/</span>awscdk<span style=color:#f92672>/</span>examples<span style=color:#f92672>/</span>unicorn<span style=color:#f92672>/</span>handler<span style=color:#f92672>/</span>InvokePriming.<span style=color:#a6e22e>java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> software.amazon.awscdk.examples.unicorn.handler;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.crac.Core;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.crac.Resource;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InvokePriming</span> <span style=color:#66d9ef>implements</span> RequestHandler<span style=color:#f92672>&lt;</span>APIGatewayV2HTTPEvent, APIGatewayV2HTTPResponse<span style=color:#f92672>&gt;</span>, Resource {
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> APIGatewayV2HTTPResponse <span style=color:#a6e22e>handleRequest</span>(APIGatewayV2HTTPEvent event, Context context) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> awsLambdaInitializationType <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>getenv</span>(<span style=color:#e6db74>&#34;AWS_LAMBDA_INITIALIZATION_TYPE&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> unicorns <span style=color:#f92672>=</span> getUnicorns();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> body <span style=color:#f92672>=</span> gson.<span style=color:#a6e22e>toJson</span>(unicorns);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> APIGatewayV2HTTPResponse.<span style=color:#a6e22e>builder</span>().<span style=color:#a6e22e>withStatusCode</span>(200).<span style=color:#a6e22e>withBody</span>(body).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeCheckpoint</span>(org.<span style=color:#a6e22e>crac</span>.<span style=color:#a6e22e>Context</span><span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Resource<span style=color:#f92672>&gt;</span> context)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> event <span style=color:#f92672>=</span> APIGatewayV2HTTPEvent.<span style=color:#a6e22e>builder</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    handleRequest(event, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Step 3: Implement Class priming Approach:</strong></p><p>The class priming approach focuses on pre-loading required classes to achieve optimal performance. To implement class priming, generate the list of classes that are loaded during the application startup and function execution by running the application locally using the following JVM argument: <code>-Xlog:class+load=info:classes-loaded.txt</code></p><ol><li><p>Ensure that your application classes included in the generated <code>classes-loaded.txt</code> file are not mutating state during static initialization. Note: the generated <code>classes-loaded.txt</code> contains class entries in the following format: <code>[0.068s][info][class,load] software.amazon.awscdk.examples.unicorn.handler.ClassPriming source: file:/var/task/</code></p></li><li><p>Extract only the fully qualified class names from each line and remove the additional logging information. For Example: <code>software.amazon.awscdk.examples.unicorn.handler.ClassPriming</code></p></li><li><p>Use the <code>ClassLoaderUtil.loadClassesFromFile()</code> utility method to extract the generated class entries.</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//src/main/java/software/amazon/awscdk/examples/unicorn/service/ClassLoaderUtil.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> software.amazon.awscdk.examples.unicorn;
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ClassLoaderUtil</span> {
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loadClassesFromFile</span>() {
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;loadClassesFromFile-&gt;started&#34;</span>);
</span></span><span style=display:flex><span>        Path path <span style=color:#f92672>=</span> Paths.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;classes-loaded.txt&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> (BufferedReader bufferedReader <span style=color:#f92672>=</span> Files.<span style=color:#a6e22e>newBufferedReader</span>(path)) {
</span></span><span style=display:flex><span>            Stream<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> lines <span style=color:#f92672>=</span> bufferedReader.<span style=color:#a6e22e>lines</span>();
</span></span><span style=display:flex><span>            lines.<span style=color:#a6e22e>forEach</span>(line <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>var</span> index1 <span style=color:#f92672>=</span> line.<span style=color:#a6e22e>indexOf</span>(<span style=color:#e6db74>&#34;[class,load] &#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>var</span> index2 <span style=color:#f92672>=</span> line.<span style=color:#a6e22e>indexOf</span>(<span style=color:#e6db74>&#34; source: &#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (index1 <span style=color:#f92672>&lt;</span> 0 <span style=color:#f92672>||</span> index2 <span style=color:#f92672>&lt;</span> 0) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>var</span> className <span style=color:#f92672>=</span> line.<span style=color:#a6e22e>substring</span>(index1 <span style=color:#f92672>+</span> 13, index2);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    Class.<span style=color:#a6e22e>forName</span>(className, <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                            ClassPriming.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getClassLoader</span>());
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>catch</span> (Throwable ignored) {
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;loadClassesFromFile-&gt;finished&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (IOException exception) {
</span></span><span style=display:flex><span>            log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Error on newBufferedReader&#34;</span>, exception);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li><p>Read a file (such as, <code>/classes-loaded.txt</code>) that contains a list of classes that have been loaded during the application&rsquo;s execution in the <code>beforeCheckpoint()</code> method.</p></li><li><p>Use the <code>Class.forName()</code> method to load and initialize the class, ensuring that it is ready during the snapshot. Note: by systematically pre-loading these classes, the Class priming approach simplifies the optimization process and reduces the complexities associated with Invoke priming.</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//src/main/java/software/amazon/awscdk/examples/unicorn/handler/ClassPriming.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> software.amazon.awscdk.examples.unicorn.handler;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.crac.Core;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.crac.Resource;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ClassPriming</span> <span style=color:#66d9ef>implements</span> RequestHandler<span style=color:#f92672>&lt;</span>APIGatewayV2HTTPEvent, APIGatewayV2HTTPResponse<span style=color:#f92672>&gt;</span>, Resource {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>        ConfigurableApplicationContext configurableApplicationContext <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>				SpringApplication.<span style=color:#a6e22e>run</span>(UnicornApplication.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>unicornService</span> <span style=color:#f92672>=</span> configurableApplicationContext.<span style=color:#a6e22e>getBean</span>(UnicornService.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>gson</span> <span style=color:#f92672>=</span> configurableApplicationContext.<span style=color:#a6e22e>getBean</span>(Gson.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Core.<span style=color:#a6e22e>getGlobalContext</span>().<span style=color:#a6e22e>register</span>(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> APIGatewayV2HTTPResponse <span style=color:#a6e22e>handleRequest</span>(APIGatewayV2HTTPEvent event, Context context) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> unicorns <span style=color:#f92672>=</span> getUnicorns();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> body <span style=color:#f92672>=</span> gson.<span style=color:#a6e22e>toJson</span>(unicorns);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> APIGatewayV2HTTPResponse.<span style=color:#a6e22e>builder</span>().<span style=color:#a6e22e>withStatusCode</span>(200).<span style=color:#a6e22e>withBody</span>(body).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeCheckpoint</span>(org.<span style=color:#a6e22e>crac</span>.<span style=color:#a6e22e>Context</span><span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Resource<span style=color:#f92672>&gt;</span> context)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ClassLoaderUtil.<span style=color:#a6e22e>loadClassesFromFile</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Step 4: AWS CDK Infrastructure Setup</strong></p><p>Before proceeding, review the prerequisites in the project <a href=https://github.com/aws-samples/lambda-priming-crac-java-cdk/tree/main#requirements>README</a> file.</p><p>The CDK stack deploys a serverless application and required infrastructure for testing different Lambda optimization strategies. It creates a VPC with private subnets, an RDS for PostgreSQL instance with a database proxy, and five Lambda functions implementing different optimization approaches (ON_DEMAND without SnapStart, SnapStart without priming, SnapStart with invoke priming, and SnapStart with class priming). Each Lambda function is integrated with API Gateway for HTTP access, configured with Java 21 runtime on ARM64 architecture, and includes CloudWatch log groups for monitoring.</p><p>Follow these steps to deploy the infrastructure:</p><ol><li>Clone the sample repository:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/aws-samples/lambda-priming-crac-java-cdk.git
</span></span></code></pre></div><ol start=2><li>Deploy the CDK stack:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd lambda-priming-crac-java-cdk/infrastructure
</span></span><span style=display:flex><span>cdk synth
</span></span><span style=display:flex><span>cdk deploy --require-approval never --all 2&gt;&amp;<span style=color:#ae81ff>1</span> | tee cdk_output.txt
</span></span></code></pre></div><ol start=3><li>Save the API Gateway URLs: The deployment will output five URLs in this format:</li></ol><pre tabindex=0><code># ON_DEMAND endpoint (without SnapStart)
LambdaPrimingCracJavaCdkStack.PrimingJavaRestApi1ONDEMANDEndpoint = https://[id].execute-api.us-east-1.amazonaws.com/prod/

# SnapStart without priming endpoint
LambdaPrimingCracJavaCdkStack.PrimingJavaRestApi2SnapStartNOPRIMINGEndpoint = https://[id].execute-api.us-east-1.amazonaws.com/prod/

# SnapStart with invoke priming endpoint
LambdaPrimingCracJavaCdkStack.PrimingJavaRestApi3SnapStartINVOKEPRIMINGEndpoint = https://[id].execute-api.us-east-1.amazonaws.com/prod/

# SnapStart with class priming endpoint
LambdaPrimingCracJavaCdkStack.PrimingJavaRestApi4SnapStartCLASSPRIMINGEndpoint = https://[id].execute-api.us-east-1.amazonaws.com/prod/

# Database setup endpoint
LambdaPrimingCracJavaCdkStack.PrimingJavaRestApi5DBLOADEREndpoint = https://[id].execute-api.us-east-1.amazonaws.com/prod/
</code></pre><ol start=4><li>Extract the URLs into variables for testing:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ONDEMAND_URL<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep -oE <span style=color:#e6db74>&#39;https://[a-zA-Z0-9.-]+\.execute-api\.[a-zA-Z0-9-]+\.amazonaws\.com/prod/&#39;</span> <span style=color:#e6db74>&#34;cdk_output.txt&#34;</span> | head -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>NOPRIMING_URL<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep -oE <span style=color:#e6db74>&#39;https://[a-zA-Z0-9.-]+\.execute-api\.[a-zA-Z0-9-]+\.amazonaws\.com/prod/&#39;</span> <span style=color:#e6db74>&#34;cdk_output.txt&#34;</span> | head -n <span style=color:#ae81ff>2</span> | tail -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>INVOKEPRIMING_URL<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep -oE <span style=color:#e6db74>&#39;https://[a-zA-Z0-9.-]+\.execute-api\.[a-zA-Z0-9-]+\.amazonaws\.com/prod/&#39;</span> <span style=color:#e6db74>&#34;cdk_output.txt&#34;</span> | head -n <span style=color:#ae81ff>3</span> | tail -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>CLASSPRIMING_URL<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep -oE <span style=color:#e6db74>&#39;https://[a-zA-Z0-9.-]+\.execute-api\.[a-zA-Z0-9-]+\.amazonaws\.com/prod/&#39;</span> <span style=color:#e6db74>&#34;cdk_output.txt&#34;</span> | head -n <span style=color:#ae81ff>4</span> | tail -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>SETUP_URL<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep -oE <span style=color:#e6db74>&#39;https://[a-zA-Z0-9.-]+\.execute-api\.[a-zA-Z0-9-]+\.amazonaws\.com/prod/&#39;</span> <span style=color:#e6db74>&#34;cdk_output.txt&#34;</span> | head -n <span style=color:#ae81ff>5</span> | tail -n 1<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p><strong>Step 5: Load database and run performance testing using <a href=https://www.artillery.io/>artillery</a>:</strong></p><ol><li>Initialize the database with sample data.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;</span>$SETUP_URL<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Expected output: {&#34;message&#34;:&#34;Database schema initialized and data loaded&#34;}</span>
</span></span></code></pre></div><ol start=2><li>Run performance tests for all endpoints</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>artillery run -t <span style=color:#e6db74>&#34;</span>$ONDEMAND_URL<span style=color:#e6db74>&#34;</span> -v <span style=color:#e6db74>&#39;{ &#34;url&#34;: &#34;/unicorn&#34; }&#39;</span> ./loadtest.yaml <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>artillery run -t <span style=color:#e6db74>&#34;</span>$NOPRIMING_URL<span style=color:#e6db74>&#34;</span> -v <span style=color:#e6db74>&#39;{ &#34;url&#34;: &#34;/unicorn&#34; }&#39;</span> ./loadtest.yaml <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>artillery run -t <span style=color:#e6db74>&#34;</span>$INVOKEPRIMING_URL<span style=color:#e6db74>&#34;</span> -v <span style=color:#e6db74>&#39;{ &#34;url&#34;: &#34;/unicorn&#34; }&#39;</span> ./loadtest.yaml <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>artillery run -t <span style=color:#e6db74>&#34;</span>$CLASSPRIMING_URL<span style=color:#e6db74>&#34;</span> -v <span style=color:#e6db74>&#39;{ &#34;url&#34;: &#34;/unicorn&#34; }&#39;</span> ./loadtest.yaml
</span></span></code></pre></div><p><strong>Step 6: Compare the load test results</strong> for On-demand (non-SnapStart), SnapStart, Invoke priming, and Class priming</p><p>The performance test results in the table below are sorted from slowest to fastest startup latency. The function without SnapStart performs the slowest due to JVM initialization, class loading and JIT compilation that occurs when the function is invoked. Notice a 4.3x improvement with SnapStart, which resumes invocations from a pre-initialized snapshot thereby avoiding JVM initialization and initial JIT compilation. SnapStart with class priming achieves a 1.4x speed-up over SnapStart, by proactively loading/initializing classes during INIT so that they are included in your function&rsquo;s snapshot. Finally, SnapStart with invoke priming achieves the fastest performance – with a 781.68ms p99.9 cold-start latency that is 1.8x faster than SnapStart. This is because in addition to initializing classes, it also executes methods on the instances of those classes, resulting in even more components being included in the function&rsquo;s snapshot.</p><p>Note that with invoke priming, any application code you execute must either be idempotent or modify stub data only. For instance, consider application code that triggers a financial transaction. If this code is executed during invoke priming with real user data, it may drive unintended effects with potentially serious consequences. Class priming avoids this, since application classes are initialized rather than being instantiated and their methods executed. This assumes that application code does not execute state modifying logic during class initialization. We recommend that you keep these considerations in mind when using invoke and/or class priming, and choose the appropriate approach for your use case.</p><table><thead><tr><th style=text-align:left>Method</th><th style=text-align:left>Cold Start Invocations</th><th style=text-align:left>p50</th><th style=text-align:left>P90</th><th style=text-align:left>P99</th><th style=text-align:left>p99.9</th></tr></thead><tbody><tr><td style=text-align:left>PrimingLogGroup-1_ON_DEMAND</td><td style=text-align:left>128</td><td style=text-align:left>5047.94 ms</td><td style=text-align:left>5386.78 ms</td><td style=text-align:left>6158.80 ms</td><td style=text-align:left>6195.84 ms</td></tr><tr><td style=text-align:left>PrimingLogGroup-2_SnapStart_NO_PRIMING</td><td style=text-align:left>111</td><td style=text-align:left>1177.87 ms</td><td style=text-align:left>1288.73 ms</td><td style=text-align:left>1419.94 ms</td><td style=text-align:left>1425.63 ms</td></tr><tr><td style=text-align:left>PrimingLogGroup-4_SnapStart_CLASS_PRIMING</td><td style=text-align:left>82</td><td style=text-align:left>857.81 ms</td><td style=text-align:left>997.49 ms</td><td style=text-align:left>1085.94 ms</td><td style=text-align:left>1085.94 ms</td></tr><tr><td style=text-align:left>PrimingLogGroup-3_SnapStart_INVOKE_PRIMING</td><td style=text-align:left>66</td><td style=text-align:left>608.42 ms</td><td style=text-align:left>688.88 ms</td><td style=text-align:left>781.68 ms</td><td style=text-align:left>781.68 ms</td></tr></tbody></table><h2 id=conclusion>Conclusion</h2><p>This post showed how AWS Lambda SnapStart, enhanced by CRaC runtime hooks, unlocks granular control over cold-start optimization for Java applications through two distinct priming strategies:</p><ul><li><strong>Invoke Priming</strong>: improves performance by executing critical endpoints during snapshot creation, ideal for idempotent workflows.</li><li><strong>Class Priming</strong>: preloads classes without triggering business logic, mitigating side-effect risks.</li></ul><p>To implement these optimization techniques in your applications evaluate your use case and opt for the optimal priming approach. Track latency reductions and resource utilization of your application via Amazon CloudWatch metrics to quantify performance improvements. By integrating these strategies, developers can achieve sub-second cold starts while maintaining the scalability and cost-efficiency of serverless architecture using Java.</p><p>To dive deeper, check out the <a href=https://github.com/aws-samples/lambda-priming-crac-java-cdk>GitHub repository</a> with the full example code, including setup instructions and reusable patterns you can adapt to your own projects. For more <a href="https://serverlessland.com/repos?services=lambda&runtime=Java">examples of Java applications running on AWS Lambda</a>, visit <a href=https://serverlessland.com/>serverlessland.com</a> and explore a wide range of resources, tutorials, and real-world use cases.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=../../3-blogstranslated/3.1-blog1/ title="Blog 1"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=../../3-blogstranslated/3.3-blog3/ title="Blog 3" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=../../js/clipboard.min.js?1765364014></script><script src=../../js/perfect-scrollbar.min.js?1765364014></script><script src=../../js/perfect-scrollbar.jquery.min.js?1765364014></script><script src=../../js/jquery.sticky.js?1765364014></script><script src=../../js/featherlight.min.js?1765364014></script><script src=../../js/highlight.pack.js?1765364014></script><script>hljs.initHighlightingOnLoad()</script><script src=../../js/modernizr.custom-3.6.0.js?1765364014></script><script src=../../js/learn.js?1765364014></script><script src=../../js/hugo-learn.js?1765364014></script><link href=../../mermaid/mermaid.css?1765364014 rel=stylesheet><script src=../../mermaid/mermaid.js?1765364014></script><script>mermaid.initialize({startOnLoad:!0})</script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,(e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date),(i=t.createElement(n),a=t.getElementsByTagName(n)[0]),i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-158079754-2","auto"),ga("send","pageview")</script></body></html>