AWSTemplateFormatVersion: "2010-09-09"
Description: API Gateway for Smart Office (Full CORS Fixed - Added RequestTemplates)

Parameters:
  EnvironmentName:
    Type: String
    Default: prod
    AllowedValues: [dev, prod]
  AuthStackName:
    Type: String
    Default: "SmartOffice-Cognito-Dev"
  AuthLambdaStackName:
    Type: String
    Default: "SmartOffice-Authenticate-Lambda-Dev"
  CrudLambdaStackName:
    Type: String
    Default: "SmartOffice-Crud-Lambda-Dev"
  IoTLambdaStackName:
    Type: String
    Default: "SmartOffice-IoT-Lambda-Dev"
  ReadOnlyLambdaStackName:
    Type: String
    Default: "SmartOffice-ReadOnly-Lambda-Dev"

Resources:
  # --- API GATEWAY ROOT ---
  SmartOfficeApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub "${AWS::StackName}-Api"
      EndpointConfiguration: { Types: ["REGIONAL"] }

  # --- AUTHORIZER ---
  CognitoAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: !Sub "${AWS::StackName}-CognitoAuthorizer"
      Type: COGNITO_USER_POOLS
      IdentitySource: method.request.header.Authorization
      RestApiId: !Ref SmartOfficeApi
      ProviderARNs:
        - Fn::ImportValue: !Sub "${AuthStackName}-UserPoolArn"

  # ====================================================================
  # 1. RESOURCES (PATHS)
  # ====================================================================

  # --- /auth ---
  AuthResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !GetAtt SmartOfficeApi.RootResourceId
      PathPart: "auth"

  LoginResource: # /auth/login
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AuthResource
      PathPart: "login"

  LogoutResource: # /auth/logout
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AuthResource
      PathPart: "logout"

  SignupResource: # /auth/signup
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AuthResource
      PathPart: "signup"

  VerifySignupResource: # /auth/verify
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AuthResource
      PathPart: "verify"

  ResendCodeResource: # /auth/resend-code
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AuthResource
      PathPart: "resend-code"

  ForgotPasswordResource: # /auth/forgot-password
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AuthResource
      PathPart: "forgot-password"

  ConfirmForgotPasswordResource: # /auth/confirm-forgot-password
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AuthResource
      PathPart: "confirm-forgot-password"

  ChangeTemporaryPasswordResource: # /auth/change-temporary-password
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AuthResource
      PathPart: "change-temporary-password"

  # --- /admin ---
  AdminResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !GetAtt SmartOfficeApi.RootResourceId
      PathPart: "admin"

  OfficeWithManagerResource: # /admin/office-with-manager
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AdminResource
      PathPart: "office-with-manager"

  ListOfficeResource: # /admin/list-office-and-manager
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AdminResource
      PathPart: "list-office-and-manager"

  OfficeDetailResource: # /admin/office-detail
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AdminResource
      PathPart: "office-detail"

  UpdateOfficeResource: # /admin/update-office-and-manager
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AdminResource
      PathPart: "update-office-and-manager"

  DeleteOfficeResource: # /admin/delete-office-and-manager
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref AdminResource
      PathPart: "delete-office-and-manager"

  # --- /users ---
  UsersResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !GetAtt SmartOfficeApi.RootResourceId
      PathPart: "users"

  UpdateProfileResource: # /users/profile
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref UsersResource
      PathPart: "profile"

  UserOfficeResource: # /users/office
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref UsersResource
      PathPart: "office"

  # --- /rooms ---
  RoomsListResource: # /rooms
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !GetAtt SmartOfficeApi.RootResourceId
      PathPart: "rooms"

  RoomConfigResource: # /rooms/config
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref RoomsListResource
      PathPart: "config"

  RoomDetailResource: # /rooms/{roomId}
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !Ref RoomsListResource
      PathPart: "{roomId}"

  LogsResource: # /logs
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ParentId: !GetAtt SmartOfficeApi.RootResourceId
      PathPart: "logs"

  # ====================================================================
  # 2. METHODS (LOGIC + OPTIONS)
  # ====================================================================

  # --- AUTHENTICATION ---

  # 1. LOGIN
  LoginPost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref LoginResource
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${AuthLambdaStackName}-LoginFunctionArn"

  LoginOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref LoginResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # 2. LOGOUT
  LogoutPost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref LogoutResource
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${AuthLambdaStackName}-LogoutFunctionArn"

  LogoutOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref LogoutResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # 3. SIGNUP
  SignupPost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref SignupResource
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${AuthLambdaStackName}-SignupFunctionArn"

  SignupOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref SignupResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # 4. VERIFY SIGNUP
  VerifySignupPost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref VerifySignupResource
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${AuthLambdaStackName}-VerifySignupFunctionArn"

  VerifySignupOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref VerifySignupResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # 5. RESEND CODE
  ResendCodePost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref ResendCodeResource
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${AuthLambdaStackName}-ResendCodeFunctionArn"

  ResendCodeOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref ResendCodeResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # 6. FORGOT PASSWORD
  ForgotPasswordPost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref ForgotPasswordResource
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${AuthLambdaStackName}-ForgotPasswordFunctionArn"

  ForgotPasswordOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref ForgotPasswordResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # 7. CONFIRM FORGOT PASSWORD
  ConfirmForgotPasswordPost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref ConfirmForgotPasswordResource
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${AuthLambdaStackName}-ConfirmPasswordFunctionArn"

  ConfirmForgotPasswordOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref ConfirmForgotPasswordResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # 8. CHANGE TEMPORARY PASSWORD
  ChangeTemporaryPasswordPost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref ChangeTemporaryPasswordResource
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${AuthLambdaStackName}-ChangeTemporaryPasswordFunctionArn"

  ChangeTemporaryPasswordOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref ChangeTemporaryPasswordResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # --- ADMIN & USER (CRUD) ---

  # 9. UPDATE PROFILE
  UpdateProfilePost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref UpdateProfileResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${CrudLambdaStackName}-UpdateProfileFunctionArn"

  UpdateProfileOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref UpdateProfileResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # 10. OFFICE WITH MANAGER (CREATE/UPDATE/DELETE)
  CreateOfficeManagerPost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref OfficeWithManagerResource # Giữ nguyên
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${CrudLambdaStackName}-CreateOfficeAndManagerFunctionArn"

  # Options cho Create (Chỉ cho phép POST)
  OfficeManagerOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref OfficeWithManagerResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'" # SỬA: Bỏ PUT, DELETE, GET
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  ListOfficeGet: # Đổi tên Logical ID cho rõ nghĩa
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref ListOfficeResource # SỬA: Trỏ vào resource mới
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-ListOfficeAndManagerFunctionArn"

  ListOfficeOptions: # THÊM MỚI
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref ListOfficeResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  OfficeDetailGet:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref OfficeDetailResource
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-GetOfficeDetailFunctionArn"

  OfficeDetailOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref OfficeDetailResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  UpdateOfficeManagerPut:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref UpdateOfficeResource # SỬA: Trỏ vào resource mới
      HttpMethod: PUT
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${CrudLambdaStackName}-UpdateOfficeAndManagerFunctionArn"

  UpdateOfficeOptions: # THÊM MỚI
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref UpdateOfficeResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'PUT,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  DeleteOfficeManagerDelete:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref DeleteOfficeResource # SỬA: Trỏ vào resource mới
      HttpMethod: DELETE
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${CrudLambdaStackName}-DeleteOfficeAndManagerFunctionArn"

  DeleteOfficeOptions: # THÊM MỚI
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref DeleteOfficeResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'DELETE,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # --- IoT & READONLY ---

  # 12. ROOM CONFIG (CREATE/UPDATE/DELETE)
  CreateRoomConfigPost:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref RoomConfigResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${IoTLambdaStackName}-CreateRoomConfigFunctionArn"

  UpdateRoomConfigPut:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref RoomConfigResource
      HttpMethod: PUT
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${IoTLambdaStackName}-UpdateRoomConfigFunctionArn"

  DeleteRoomConfigDelete:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref RoomConfigResource
      HttpMethod: DELETE
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${IoTLambdaStackName}-DeleteRoomConfigFunctionArn"

  RoomConfigOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref RoomConfigResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'POST,PUT,DELETE,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # 13. LIST ROOMS
  ListRoomsGet:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref RoomsListResource
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-ListRoomFunctionArn"

  ListRoomsOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref RoomsListResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # 14. GET ROOM DETAIL
  GetRoomDetailGet:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref RoomDetailResource
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-GetRoomConfigFunctionArn"

  # 15. GET SENSOR LOGS (NEW FUNCTION for /logs)
  LogsGet:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref LogsResource
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations"
          - LambdaArn:
              Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-GetDataFunctionArn"

  LogsOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref LogsResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  RoomDetailOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref SmartOfficeApi
      ResourceId: !Ref RoomDetailResource
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        # --- BỔ SUNG REQUEST TEMPLATES ---
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,Referer,User-Agent'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: "{}"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true
            method.response.header.Access-Control-Allow-Origin: true

  # ====================================================================
  # 3. PERMISSIONS (FULL LIST - NO MORE 500 ERRORS)
  # ====================================================================

  LoginPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${AuthLambdaStackName}-LoginFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  LogoutPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${AuthLambdaStackName}-LogoutFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  SignupPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${AuthLambdaStackName}-SignupFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  VerifySignupPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${AuthLambdaStackName}-VerifySignupFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  ResendCodePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${AuthLambdaStackName}-ResendCodeFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  ForgotPasswordPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${AuthLambdaStackName}-ForgotPasswordFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  ConfirmForgotPasswordPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${AuthLambdaStackName}-ConfirmPasswordFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  ChangeTemporaryPasswordPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${AuthLambdaStackName}-ChangeTemporaryPasswordFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  UpdateProfilePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${CrudLambdaStackName}-UpdateProfileFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  CreateOfficeManagerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${CrudLambdaStackName}-CreateOfficeAndManagerFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  UpdateOfficeManagerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${CrudLambdaStackName}-UpdateOfficeAndManagerFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  DeleteOfficeManagerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${CrudLambdaStackName}-DeleteOfficeAndManagerFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  ListOfficeAndManagerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-ListOfficeAndManagerFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  GetOfficeDetailPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-GetOfficeDetailFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  CreateRoomConfigPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${IoTLambdaStackName}-CreateRoomConfigFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  UpdateRoomConfigPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${IoTLambdaStackName}-UpdateRoomConfigFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  DeleteRoomConfigPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${IoTLambdaStackName}-DeleteRoomConfigFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  ListRoomPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-ListRoomFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  GetRoomPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-GetRoomConfigFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  GetDataPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-GetDataFunctionArn"
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SmartOfficeApi}/*/*/*"

  # ====================================================================
  # 4. DEPLOYMENT (FORCE UPDATE)
  # ====================================================================

  ApiDeploymentFinalV1:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - LoginPost
      - LoginOptions
      - LogoutPost
      - LogoutOptions
      - SignupPost
      - SignupOptions
      - VerifySignupPost
      - VerifySignupOptions
      - ResendCodePost
      - ResendCodeOptions
      - ForgotPasswordPost
      - ForgotPasswordOptions
      - ConfirmForgotPasswordPost
      - ConfirmForgotPasswordOptions
      - ChangeTemporaryPasswordPost
      - ChangeTemporaryPasswordOptions
      - UpdateProfilePost
      - UpdateProfileOptions
      - CreateOfficeManagerPost
      - UpdateOfficeManagerPut
      - DeleteOfficeManagerDelete
      - OfficeManagerOptions
      - CreateRoomConfigPost
      - UpdateRoomConfigPut
      - DeleteRoomConfigDelete
      - RoomConfigOptions
      - ListRoomsGet
      - ListRoomsOptions
      - GetRoomDetailGet
      - RoomDetailOptions
      - LogsGet
      - LogsOptions
      - ListOfficeGet
      - ListOfficeOptions
      - OfficeDetailGet
      - OfficeDetailOptions
      - UpdateOfficeOptions
      - DeleteOfficeOptions
    Properties:
      RestApiId: !Ref SmartOfficeApi

  ApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      StageName: !Ref EnvironmentName
      RestApiId: !Ref SmartOfficeApi
      DeploymentId: !Ref ApiDeploymentFinalV1

Outputs:
  ApiEndpoint:
    Description: "API Gateway Url"
    Value: !Sub "https://${SmartOfficeApi}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentName}"
    Export:
      Name: !Sub "${AWS::StackName}-ApiEndpoint"

  # Helper Outputs to resolve ARNs in the Resources section (Hidden magic)
  LoginFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${AuthLambdaStackName}-LoginFunctionArn"
  LogoutFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${AuthLambdaStackName}-LogoutFunctionArn"
  SignupFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${AuthLambdaStackName}-SignupFunctionArn"
  VerifySignupFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${AuthLambdaStackName}-VerifySignupFunctionArn"
  ResendCodeFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${AuthLambdaStackName}-ResendCodeFunctionArn"
  ForgotPasswordFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${AuthLambdaStackName}-ForgotPasswordFunctionArn"
  ConfirmPasswordFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${AuthLambdaStackName}-ConfirmPasswordFunctionArn"
  ChangeTemporaryPasswordFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${AuthLambdaStackName}-ChangeTemporaryPasswordFunctionArn"
  UpdateProfileFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${CrudLambdaStackName}-UpdateProfileFunctionArn"
  CreateOfficeAndManagerFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${CrudLambdaStackName}-CreateOfficeAndManagerFunctionArn"
  UpdateOfficeAndManagerFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${CrudLambdaStackName}-UpdateOfficeAndManagerFunctionArn"
  DeleteOfficeAndManagerFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${CrudLambdaStackName}-DeleteOfficeAndManagerFunctionArn"
  ListOfficeAndManagerFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-ListOfficeAndManagerFunctionArn"
  GetOfficeDetailFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-GetOfficeDetailFunctionArn"
  CreateRoomConfigFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${IoTLambdaStackName}-CreateRoomConfigFunctionArn"
  UpdateRoomConfigFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${IoTLambdaStackName}-UpdateRoomConfigFunctionArn"
  DeleteRoomConfigFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${IoTLambdaStackName}-DeleteRoomConfigFunctionArn"
  ListRoomFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-ListRoomFunctionArn"
  GetRoomConfigFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-GetRoomConfigFunctionArn"
  GetDataFunctionArn:
    Value:
      Fn::ImportValue: !Sub "${ReadOnlyLambdaStackName}-GetDataFunctionArn"
